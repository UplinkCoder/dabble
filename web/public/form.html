
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Dabble</title>
    
    <script src="/codemirror.js"></script>
    <script src="/show-hint.js"></script>
    <script src="/d-hint.js"></script>
    <script src="/mode/d.js"></script>
    <link rel="stylesheet" href="codemirror.css">
    <link rel="stylesheet" href="style.css">
    
    <link href='http://fonts.googleapis.com/css?family=Fauna+One' rel='stylesheet' type='text/css'>
    
    <script src="/json_sans_eval.js"></script>

  </head>
  <body>
           
        
    <div id="centerPane">
    
      <div id="titleOuter"> 
        <div id="titleInner">                 
          <img id="logo" src="dlogosmall.png" /> <span id="titleText"> abble </span>
        </div>
      </div>
      
      <div id="splitPane">
      
        <div id="codePane">
        
          <textarea id="history"></textarea>  

          <div id="input">
            <div id="prompt"> >> </div>
            <textarea id="code" class="editor"></textarea>  
          </div>      
        
        </div>
        
        <div id="libPane">
          <div>
            <input id="searchBoxUnder" class="overlap" size="30" spellcheck="false" type="text">
            <input id="searchBox" class="overlap" onkeyup="searchInput()" size="30" spellcheck="false" type="text">
          </div>
          <br>
          <br>
          <br>
          
          <div id="suggestionsPane"></div>
        </div>
        
      </div> 
      
    </div>
  


 <script>
 
   window.onkeydown = function() { return handleWindowEvent(event); }; 
   
   var lineIndex = 0; // for moving through the history
   
   function handleWindowEvent(e) {   
        if (event.ctrlKey == true) {
        
            if (event.keyCode == 70) {
                toggleSearchPaneVisibility();
                return false;
            }                        
        }   
        return true;
   }
           
   if(typeof(String.prototype.trim) === "undefined") {
      String.prototype.trim = function() {
      return String(this).replace(/^\s+|\s+$/g, '');
    };
   }
   
   // Retrieve Dabble version
   window.onload = function() {
      var xhr = createCORSRequest('GET', '/welcome');
      xhr.setRequestHeader('Content-type', 'text/plain;');        
      xhr.onload = function() {
        var responseText = xhr.responseText;    
        updateHistory(responseText);        
      };     
      xhr.send();
    }; 

 
   var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
         mode:"text/x-d",
         viewportMargin: Infinity,
         lineWrapping: true, 
         extraKeys: {"Ctrl-Down": "autocomplete"}
   });
   
   var history = CodeMirror.fromTextArea(document.getElementById("history"), {
         mode:"text/x-d",
         viewportMargin: Infinity,
         readOnly: "nocursor",
         lineNumbers: true,
         lineWrapping: true
   });
   
   editor.setOption("theme", "dabble");
   history.setOption("theme", "dabble");
   
   CodeMirror.commands.autocomplete = function(cm) {        
        CodeMirror.showHint(cm, CodeMirror.dHint, autoCompleteOptions);
   }
   
   var autoCompleteOptions = {
        async: true,
        completeSingle: false        
   }      
          
   editor.options.onKeyEvent = 
    function(cm, e) {     
                    
      // If currently auto-completing, do nothing
      if (editor.state.completionActive) 
        return;                    
                  
      if (!e || !(e instanceof KeyboardEvent)) 
        return;
        
      if (e.ctrlKey == true) {             
        return;
      }
      
      if (e.type == 'keydown' &&
          e.shiftKey == false &&           
          e.keyCode == 13) {
          
        var text = editor.getValue();        
        lineIndex = 0;
        updateHistory(text);
        send(text);
        editor.setValue("");
        e.preventDefault();        
        return true;  
      
      } else if (e.type == 'keydown' &&                                  
                 editor.lineCount() == 1 && 
                 (e.keyCode == 38 || e.keyCode == 40 )) {
                 
        if (e.keyCode == 38) {
          editor.setValue(retrieveHistory('up'));
        } else {
          editor.setValue(retrieveHistory('down'));
        }      
        return true;
      } 
    
    };  
        
        
    function retrieveHistory(dir) {
      
      if (dir == 'up') {
        if (lineIndex > 0) 
          lineIndex--;        
      } else if (dir == 'down') {
        if (lineIndex < history.lineCount()) 
          lineIndex++;        
      }           
      return history.getLine(lineIndex);
    }
            

    function updateHistory(text) { 
                 
      if (text.length == 0) { return; }      
        
      if (history.getLine(0) == "") {
        history.setValue(text);     
      } else {
        history.setValue(history.getValue() + "\n" + text);     
      }       
      lineIndex = history.lineCount();
      var el = document.getElementById("codePane");
      el.scrollTop = el.scrollHeight;
    }       
    
    function send(text) {
      var xhr = createCORSRequest('POST', '/input');
      xhr.setRequestHeader('Content-type', 'text/plain;');
        
      xhr.onload = function() {
        var responseText = xhr.responseText;
        var lines = responseText.split("\n");
        var text = "";
        for (var i = 0; i < lines.length; i++) {             
          var str = lines[i].replace(/(\r\n|\n|\r)/gm,"");         
          updateHistory(str);            
        }
      };    
  
      xhr.send(text.split(/\u00A0/g).join(" "));
    }
    
    function createCORSRequest(method, url) {
      var xhr = new XMLHttpRequest();
      if ("withCredentials" in xhr) {        
        xhr.open(method, url, true);
      } else if (typeof XDomainRequest != "undefined") {        
        xhr = new XDomainRequest();
        xhr.open(method, url);
      } else {
        xhr = null;
      }
      return xhr;
    }
    
</script>
  
  </body>
</html>
